#!/bin/bash

# common shell routines for s2i scripts

function move_artifacts() {
  echo "Copying all *-bootified.war artifacts from $LOCAL_SOURCE_DIR/$1 directory into $DEPLOY_DIR for later deployment..."
  cp -rfv $LOCAL_SOURCE_DIR/$1/*${APP_SUFFIX}.war $DEPLOY_DIR 2> /dev/null
}

# handle incremental builds. If we have been passed build artifacts, untar
# them over the supplied source.
manage_incremental_build() {
    if [ -d /tmp/artifacts ]; then
        echo "Expanding artifacts from incremental build..."
        ( cd /tmp/artifacts && tar cf - . ) | ( cd ${HOME} && tar xvf - )
        rm -rf /tmp/artifacts
    fi
}

# s2i 'save-artifacts' routine
s2i_save_build_artifacts() {
    cd ${HOME}
    tar cf - .m2
}

install_node_modules() {
  # build the client part if available
  if [ -n "$CLIENT_SOURCE_DIR" ]; then

    PROXY_SETTINGS=""
    if [ -n "$NPM_PROXY_URL" ]; then
      PROXY_SETTINGS="--proxy ${NPM_PROXY_URL} --https-proxy ${NPM_PROXY_URL} --strict-ssl false"
    fi

    NPM_ARGS="${PROXY_SETTINGS} -g install --no-optional"
    echo "Installing node modules ..."
    echo "npm ${NPM_ARGS}"

    # save the current location
    CURRENT_DIR=`pwd`
    
    # build the AngularJS parts
    cd $LOCAL_SOURCE_DIR/$CLIENT_SOURCE_DIR
    npm $NPM_ARGS

    # and back to safety
    cd $CURRENT_DIR
  else
    echo "Skip installing node modules ..."
  fi
}