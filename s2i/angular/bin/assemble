#!/bin/bash

set -e

# Sources to build will be here
LOCAL_SOURCE_DIR=/tmp/src

# The location of the final application
TARGET_SOURCE_DIR=/opt/app-root/src

# Build the angular frontend

cd $LOCAL_SOURCE_DIR

echo "---> Configure sources ..."
TARGET_ENV_FILE="src/environments/environment.$BUILD_TARGET.ts"
cp src/environments/$TEMPLATE_FILE $TARGET_ENV_FILE
sed -i "s|REST_ENDPOINT|$REST_ENDPOINT|" $TARGET_ENV_FILE

if [ -n "$NPM_PROXY_URL" ]; then
  echo "---> Configure proxy ..."
  npm config set proxy $NPM_PROXY_URL
  npm config set https-proxy $NPM_PROXY_URL
  npm config set strict-ssl false
fi

echo "---> Building sources ..."
export npm_config_tmp=/tmp
yarn upgrade
yarn build:$BUILD_TARGET

echo "---> Moving sources ..."
cp -ad $LOCAL_SOURCE_DIR/$ARTIFACT_DIR/* $TARGET_SOURCE_DIR

# Apply a custom nginx configuration if available
if [ -d ./nginx-cfg ]; then
  echo "---> Copying nginx configuration files ..."
  if [ "$(ls -A ./nginx-cfg/*.conf)" ]; then
    cp -v ./nginx-cfg/*.conf "${NGINX_CONFIGURATION_PATH}"
    rm -rf ./nginx-cfg
  fi
fi

if [ -d ./nginx-default-cfg ]; then
  echo "---> Copying nginx default server configuration files ..."
  if [ "$(ls -A ./nginx-default-cfg/*.conf)" ]; then
    cp -v ./nginx-default-cfg/*.conf "${NGINX_DEFAULT_CONF_PATH}"
    rm -rf ./nginx-default-cfg
  fi
fi

echo "---> Cleaning up ..."
rm -rf /usr/lib/node_modules/*
rm -rf $LOCAL_SOURCE_DIR

# Success
exit 0